<!DOCTYPE html>
<html>
  <head>
    <!--
      /**
       * This webpage is meant to be run from a local/remote server due to reading of JSON file.
       *
       * It takes in the following querystring param(s):
       *   @param {string} data - Path to JSON file for songbook.
       *
       * @link https://github.com/zionsg/songbooks/blob/master/html/songbook.webpage.html
       */
    -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title> <!-- to be filled in by JavaScript -->

    <style>
      html,
      body {
        background-color: lightyellow;
        font-family: Helvetica, Arial, SimHei, "黑体", sans-serif;
        font-size: 16px;
      }

      footer {
        font-style: italic;
        margin-top: 1em;
        text-align: right;
      }

      table {
        border-spacing: 0;
        border-collapse: separate;
        width: 100%;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 5px;
      }
      th {
        background: #ddd;
      }
      td:not(:first-child) {
        text-align: center;
      }

      a {
        color: #0000ff;
        text-decoration: none;
      }
      a:hover {
        color: #ff00ff;
        text-decoration: underline;
      }
      a[id] {
        color: black;
        text-decoration: none;
      }
      a[id]:hover {
        color: black;
        text-decoration: none;
      }

      .songbook-title {
        margin: 0 auto;
        text-align: center;
      }

      .section-link {
        display: inline-block;
        margin: 0.5em;
      }
    </style>
  </head>

  <body>
     <!-- Empty elements to be filled in by JavaScript -->
    <h1 class="songbook-title"></h1>

    <h2>Table of Contents</h2>
    <nav class="table-of-contents"></nav>
    <main class="sections"></main>

    <footer></footer>

    <script src="js/utils.js"></script>
    <script>
      (function () {
          const COMMENTS = '//';
          const LANG_EN = 'en';
          const LANG_CN = 'cn';

          let data = null;

          /**
           * Initialization
           *
           * @returns {void}
           */
          function init() {
              let dataFile = utils.getQueryParam('data', '');
              if (!dataFile) {
                  return;
              }

              utils.readJsonFile(dataFile, function (json) {
                  // Save contents of JSON file
                  data = json;

                  // Book title and copyright
                  let bookTitles = Object.values(data['title'] || '');
                  document.title = bookTitles.join(' ');
                  document.querySelector('.songbook-title').innerHTML = bookTitles.join('<br>');
                  document.querySelector('footer').innerHTML = data['copyright'] || '';

                  // Table of contents and sections
                  let sections = data.sections || {};
                  let tableOfContentsHtml = '';
                  let sectionsHtml = '';
                  Object.entries(sections).forEach(function (entry) {
                      let sectionJsonKey = entry[0];
                      let section = entry[1];
                      let sectionResult = getSectionInfo(sectionJsonKey, section);

                      sectionResult.forEach(function (sectionInfo) {
                          tableOfContentsHtml += sectionInfo.link;

                          if (!utils.isEmpty(sectionInfo.songs)) {
                              sectionsHtml += sectionInfo.anchor + "\n<table>\n"
                                  + '<tr><th>Name</th><th>Lyrics</th><th>Music</th>'
                                  + '<th>Key/Time Signature</th><th>Notes</th></tr>';

                              sectionInfo.songs.forEach(function (song) {
                                  sectionsHtml += utils.sprintf(
                                      '<tr><td>%s%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>',
                                      song.songPrefix ? song.songPrefix + ': ' : '',
                                      song.name,
                                      song.lyrics,
                                      song.music,
                                      song.signature,
                                      song.notes
                                  );
                              });
                          }
                      });
                  });
                  document.querySelector('.table-of-contents').innerHTML = tableOfContentsHtml.trim();
                  document.querySelector('.sections').innerHTML = sectionsHtml.trim();
              });
          }

          /**
           * Get rendering for section info, including subsections
           *
           * Subsections, if any, will be placed at the same level of the section itself.
           *
           * If a section has no songList key set, no info is generated for the section itself, but if it
           * has subsections, info will be generated for those subsections (if they have songList key set).
           *
           * @param {string} key - JSON key for section. Used for English title if latter is not specified.
           * @param {object} section - JSON value for section.
           * @returns {object[]} 1st element will the section itself, followed by 1 element for each subsection if any.
           *     [
           *       {
           *         title: <combination of English and Chinese titles>,
           *         anchor: <HTML for section header anchor>,
           *         link: <HTML for section link as used in table of contents>,
           *         songs: [<as per return result of getSongInfo9)>]
           *       }
           *     ]
           */
          function getSectionInfo(key, section) {
              let result = [];
              let sectionInfo = {
                  title: '',
                  anchor: '',
                  link: '',
                  songs: []
              };

              // Skip comments
              if (COMMENTS === key) {
                  return result;
              }

              // Only generate info for current section and add to result if its songList key is set
              let songList = section.songList || [];
              if (!utils.isEmpty(songList)) {
                  let sectionTitle = resolveTitle(key, section.title);
                  let sectionVarName = utils.textToVariableName(sectionTitle);
                  let songs = (data && data.songs) || {};

                  // Song ranges
                  let songRanges = [];
                  songList.forEach(function (songRange) {
                      // For textual representation
                      songRanges.push(
                          (2 === songRange.length) ? songRange[0] + ' - ' + songRange[1] : songRange.join(', ')
                      );

                      // Collate songs
                      if (2 === songRange.length) { // convert ["1", "3"] to ["1", "2", "3"]
                          let start = parseInt(songRange[0]);
                          let end = parseInt(songRange[1]);
                          songRange = new Array(end - start + 1).fill().map((val, index) => (index + start + ''));
                      }
                      songRange.forEach(function (songJsonKey) {
                          let song = (songs && songs[songJsonKey]) || null;
                          if (!song) {
                              return;
                          }

                          sectionInfo.songs.push(getSongInfo(songJsonKey, song));
                      });
                  });

                  sectionInfo.title = sectionTitle;
                  sectionInfo.anchor = utils.sprintf(
                      '<h3><a id="%s">%s</a></h3>',
                      sectionVarName,
                      sectionTitle
                  );
                  sectionInfo.link = utils.sprintf(
                      '<div class="section-link">[<a href="#%s">%s %s</a>]</div>',
                      sectionVarName,
                      sectionTitle,
                      songRanges.join(', ')
                  );

                  result.push(sectionInfo);
              }

              // Iterate thru subsections
              let subsections = section.subsections || {};
              Object.entries(subsections).forEach(function (entry) {
                  let subsectionJsonKey = entry[0];
                  let subsection = entry[1];
                  let subsectionResult = getSectionInfo(subsectionJsonKey, subsection);

                  if (!utils.isEmpty(subsectionResult)) {
                      result = result.concat(subsectionResult);
                  }
              });

              return result;
          }

          /**
           * Get rendering for song info
           *
           * @param {string} key - JSON key for song. Used for English title if latter is not specified.
           * @param {object} song - JSON value for song.
           * @returns {object}
           *     {
           *       songPrefix: <bookPrefix + song number>
           *       name: <HTML for Name column>
           *       lyrics: <HTML for Lyrics column>
           *       music: <HTML for Music column>
           *       signature: <HTML for Key/Time Signature column>
           *       notes: <HTML for Notes column>
           *     }
           */
          function getSongInfo(key, song) {
              let bookPrefix = data.bookPrefix || '';
              let songPrefix = (null === key.match(/^\d+$/)) ? '' : (bookPrefix + key.padStart(3, '0'));
              let lyrics = song.lyrics || {};
              let music = song.music || {};
              let tune = music.tune || '';
              let notes = song.notes || [];

              return {
                  songPrefix: songPrefix,
                  name: resolveTitle(key, song.title),
                  lyrics: (lyrics.authors || []).join(', '),
                  music: (tune ? tune.toUpperCase() + '<br>' : '') + (music.composers || []).join(', '),
                  signature: (music.keySignature || []).join(', ') + '<br>' + (music.timeSignature || []).join(', '),
                  notes: notes.join('<br>')
              };
          }

          /**
           * Resolve title for section/song, combining all language versions
           *
           * @param {string} jsonKey - JSON key for section/song. This is used for the English title if latter not set.
           * @param {object} titles - Value for "titles" key in section/song, e.g. { "en":"A", "cn":"甲" }.
           * @returns {string}
           */
          function resolveTitle(jsonKey, titles) {
              titles = titles || {};

              let titleEn = titles[LANG_EN] || jsonKey || '';
              let titleCn = titles[LANG_CN] || '';

              return titleEn + (titleCn ? ' ' + titleCn : '');
          }

          // Run init
          init();
      })();
    </script>
  </body>
</html>
