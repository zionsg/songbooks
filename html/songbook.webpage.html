<!DOCTYPE html>
<html>
  <head>
    <!--
      /**
       * This webpage lists out all the songs in a songbook.
       *
       * This webpage is meant to be run from a local/remote server due to reading of JSON file.
       *
       * It takes in the following querystring param(s):
       *   @param {string} data - Path to JSON file for songbook. Must be a valid url and not a relative path.
       *   @param {string} css - Path to additional CSS file to load, before dynamic elements are rendered.
       *   @param {string} js - Path to additional Javascript file to load, after dynamic elements are rendered.
       *
       * @link https://github.com/zionsg/songbooks/blob/master/html/songbook.webpage.html
       */
    -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title> <!-- to be filled in by JavaScript -->

    <link rel="stylesheet" href="css/stylesheet.css">
    <style>
      .songbook-title {
        margin: 0 auto;
        text-align: center;
      }

      .section-link {
        display: inline-block;
        margin: 0.5em;
      }
    </style>
  </head>

  <body>
     <!-- Empty elements to be filled in by JavaScript -->
    <h1 class="songbook-title"></h1>

    <h2>Table of Contents</h2>
    <nav class="table-of-contents"></nav>
    <main class="sections"></main>

    <footer></footer>

    <script src="js/utils.js"></script>
    <script>
        (function () {
            /**
             * Constants
             *
             * @private
             * @type {string}
             */
            const CSS_CLASS_LYRICS_LINK = 'lyrics-link';
            const ATTR_SONG_KEY = 'data-song-key';

            /**
             * Parsed songbook info
             *
             * @private
             * @type {object}
             */
            let data = null;

            /**
             * Initialization - function will be run at the end of this module
             *
             * @private
             * @returns {void}
             */
            function init() {
                // Parse query params
                let dataFile = utils.getQueryParam('data', '');
                let cssFile = utils.getQueryParam('css', '');
                let jsFile = utils.getQueryParam('js', '');
                if (!dataFile) {
                    return;
                }

                utils.readJsonFile(dataFile, function (json) {
                    // Save contents of JSON file
                    data = json;
                    if (!data) {
                        return;
                    }

                    // Load additional CSS file if any
                    utils.loadStylesheet(cssFile);

                    // Book title and copyright
                    let bookTitles = Object.values(data['title'] || '');
                    document.title = bookTitles.join(' ');
                    document.querySelector('.songbook-title').innerHTML = bookTitles.join('<br>');
                    document.querySelector('footer').innerHTML = data['copyright'] || '';

                    // Table of contents and sections
                    let sections = data.sections || {};
                    let tableOfContentsHtml = '';
                    let sectionsHtml = '';
                    Object.entries(sections).forEach(function (entry) {
                        let sectionJsonKey = entry[0];
                        let section = entry[1];
                        let sectionResult = getSectionInfo(section, sectionJsonKey);

                        sectionResult.forEach(function (sectionInfo) {
                            tableOfContentsHtml += sectionInfo.link;

                            if (!utils.isEmpty(sectionInfo.songs)) {
                                sectionsHtml += sectionInfo.anchor + "\n<table>\n"
                                    + '<tr><th>Name</th><th>Lyrics</th><th>Music</th>'
                                    + '<th>Key/Time Signature</th><th>Notes</th></tr>'
                                    + "\n";

                                sectionInfo.songs.forEach(function (song) {
                                    sectionsHtml += utils.sprintf(
                                        "<tr><td>%s%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n",
                                        song.songPrefix ? song.songPrefix + ': ' : '',
                                        song.name,
                                        song.lyrics,
                                        song.music,
                                        song.signature,
                                        song.notes
                                    );
                                });

                                sectionsHtml += "</table>\n";
                            }
                        });
                    });
                    document.querySelector('.table-of-contents').innerHTML = tableOfContentsHtml.trim();
                    document.querySelector('.sections').innerHTML = sectionsHtml.trim();

                    // Add click handlers
                    Array.from(document.querySelectorAll('.' + CSS_CLASS_LYRICS_LINK)).forEach(function (link) {
                        link.addEventListener('click', function (event) {
                            showLyrics(link.getAttribute(ATTR_SONG_KEY));
                        });
                    });

                    // Load additional JS file if any
                    utils.loadScript(jsFile);
                });
            }

            /**
             * Get rendering for section info, including subsections
             *
             * Subsections, if any, will be placed at the same level of the section itself.
             *
             * If a section has no songList key set, no info is generated for the section itself, but if it
             * has subsections, info will be generated for those subsections (if they have songList key set).
             *
             * @private
             * @param {object} section - Section data.
             * @param {string} key - JSON key for section. Used for English title if latter is not specified.
             * @returns {object[]} 1st element is the section itself, followed by 1 element for each subsection if any.
             *     [
             *       {
             *         title: <combination of English and Chinese titles>,
             *         anchor: <HTML for section header anchor>,
             *         link: <HTML for section link as used in table of contents>,
             *         songs: [<as per return result of getSongInfo()>]
             *       }
             *     ]
             */
            function getSectionInfo(section, key) {
                let result = [];
                let sectionInfo = {
                    title: '',
                    anchor: '',
                    link: '',
                    songs: []
                };

                // Skip comments
                if (utils.COMMENTS === key) {
                    return result;
                }

                // Only generate info for current section and add to result if its songList key is set
                let songJsonKeys = Object.keys(data.songs || {});
                let songList = section.songList || [];
                if (!utils.isEmpty(songList)) {
                    let sectionTitle = utils.getCombinedTitle(section.title, key);
                    let sectionVarName = utils.textToVariableName(sectionTitle);
                    let songs = (data && data.songs) || {};

                    // Song ranges
                    let songRanges = [];
                    songList.forEach(function (songRange) {
                        // For textual representation
                        songRanges.push(
                            (2 === songRange.length) ? songRange[0] + ' - ' + songRange[1] : songRange.join(', ')
                        );

                        // Collate songs
                        if (2 === songRange.length) { // convert ["1", "3"] to ["1", "2", "2a", "3", "3a", "3b"]
                            let start = parseInt(songRange[0]);
                            let end = parseInt(songRange[1]);
                            let numericSongRange =
                                new Array(end - start + 1).fill().map((val, index) => (index + start + ''));

                            songRange =
                                songJsonKeys.filter((val) => numericSongRange.includes(parseInt(val).toString()));
                            songRange.sort();
                        }
                        songRange.forEach(function (songJsonKey) {
                            let song = (songs && songs[songJsonKey]) || null;
                            if (!song) {
                                return;
                            }

                            sectionInfo.songs.push(getSongInfo(song, songJsonKey));
                        });
                    });

                    sectionInfo.title = sectionTitle;
                    sectionInfo.anchor = utils.sprintf(
                        '<h3><a id="%s">%s</a></h3>',
                        sectionVarName,
                        sectionTitle
                    );
                    sectionInfo.link = utils.sprintf(
                        '<div class="section-link">[<a href="#%s">%s %s</a>]</div>',
                        sectionVarName,
                        sectionTitle,
                        songRanges.join(', ')
                    );

                    result.push(sectionInfo);
                }

                // Iterate thru subsections
                let subsections = section.subsections || {};
                Object.entries(subsections).forEach(function (entry) {
                    let subsectionJsonKey = entry[0];
                    let subsection = entry[1];
                    let subsectionResult = getSectionInfo(subsection, subsectionJsonKey);

                    if (!utils.isEmpty(subsectionResult)) {
                        result = result.concat(subsectionResult);
                    }
                });

                return result;
            }

            /**
             * Get rendering for song info
             *
             * @private
             * @param {object} song - Song data.
             * @param {string} key - JSON key for song. Used for English title if latter is not specified.
             * @returns {object}
             *     {
             *       songPrefix: <bookPrefix + song number>
             *       name: <HTML for Name column>
             *       lyrics: <HTML for Lyrics column>
             *       music: <HTML for Music column>
             *       signature: <HTML for Key/Time Signature column>
             *       notes: <HTML for Notes column>
             *     }
             */
            function getSongInfo(song, key) {
                let songPrefix = utils.getSongPrefix(data, key);
                let lyrics = song.lyrics || {};
                let music = song.music || {};
                let tune = music.tune || '';
                let notes = song.notes || [];

                let authors = (lyrics.authors || []).join(', ');
                let translators = (lyrics.translators || []).join(', ');
                let lyricsHtml = utils.sprintf(
                    '%s%s%s',
                    authors,
                    (translators && authors) ? '<br>' : '',
                    translators ? 'Translated by: ' + translators : ''
                );

                let langLyrics = utils.getLanguageLyrics(song);
                if (langLyrics) { // check if any lyrics at all
                    let slidesHtml = '';
                    let dataParam = utils.getQueryParam('data', '');
                    Object.keys(langLyrics).forEach(function (lang) {
                        if (!utils.isEmpty(langLyrics[lang])) {
                            slidesHtml += utils.sprintf(
                                ' <a target="_blank" href="song.slides.html?data=%s&song=%s&lang=%s">%s</a>',
                                dataParam,
                                key,
                                lang,
                                lang
                            );
                        }
                    });

                    lyricsHtml += utils.sprintf(
                      '%s<a href="#" class="%s" %s="%s">lyrics</a><br>slides:%s',
                      (lyricsHtml ? '<br><br>' : ''),
                      CSS_CLASS_LYRICS_LINK,
                      ATTR_SONG_KEY,
                      key,
                      slidesHtml
                    );
                }

                let composers = (music.composers || []).join(', ');
                let arrangers = (music.arrangers || []).join(', ');
                let musicHtml = utils.sprintf(
                    '%s%s%s%s',
                    tune ? tune.toUpperCase() + '<br><br>' : '',
                    composers,
                    (composers && arrangers) ? '<br>' : '',
                    arrangers ? 'Arranged by: ' + arrangers : ''
                );

                return {
                    songPrefix: songPrefix,
                    name: utils.getCombinedTitle(song.title, key),
                    lyrics: lyricsHtml,
                    music: musicHtml,
                    signature: (music.keySignature || []).join(', ') + '<br>' + (music.timeSignature || []).join(', '),
                    notes: notes.join('<br>')
                };
            }

            /**
             * Show lyrics for a song in a new window
             *
             * @private
             * @param {string} songJsonKey - JSON key for song.
             * @returns {void}
             */
            function showLyrics(songJsonKey) {
                let song = (data && data.songs && data.songs[songJsonKey]) || null;
                let lyrics = utils.getLanguageLyrics(song);
                if (!lyrics) {
                    return;
                }

                let songPrefix = utils.getSongPrefix(data, songJsonKey);
                songPrefix += songPrefix ? ': ' : '';

                // Note that lyrics open in a new child window and has no access to the CSS in parent window
                let titles = (song && song.title) || null;
                let lyricsHtml = utils.sprintf(
                    '<title>%s%s</title>' + "\n",
                    songPrefix,
                    utils.getCombinedTitle(titles, songJsonKey)
                );
                utils.LANGUAGES.forEach(function (lang) {
                    let langLyrics = lyrics[lang];
                    if (utils.isEmpty(langLyrics)) {
                        return; // continue
                    }

                    let langTitle = (titles && titles[lang]) || '';
                    lyricsHtml += utils.sprintf(
                        '<div><b>%s%s</b></div><br>',
                        songPrefix,
                        utils.getLanguageTitle(titles, songJsonKey, lang).toUpperCase()
                    );

                    Object.entries(langLyrics).forEach(function (entry) {
                        let stanzaJsonKey = entry[0];
                        let stanza = entry[1];

                        lyricsHtml += utils.sprintf(
                            '<div><i>%s</i></div>' + "\n" + '<div>%s</div>' + "\n<br>",
                            utils.isChorus(stanzaJsonKey)
                                ? utils.capitalizeFirstLetter(stanzaJsonKey)
                                : 'Stanza ' + stanzaJsonKey,
                            stanza.join('<br>')
                        );
                    });

                    lyricsHtml += '<br>';
                });

                let childWindow = window.open('about:blank'); // "about:blank" else new window cannot zoom in Chrome
                childWindow.document.write(lyricsHtml);
                childWindow.document.close();
            }

            // Run init
            init();
        })();
    </script>
  </body>
</html>
